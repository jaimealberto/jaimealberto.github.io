<!DOCTYPE html>
<html class="no-js" lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Combo I, la VPN del pobre - </title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="La VPN del pobre">
		<meta property="og:title" content="Combo I, la VPN del pobre" />
<meta property="og:description" content="La VPN del pobre" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jaimealberto.github.io/combos/01_comboi/" /><meta property="article:section" content="Combos" />




		<meta itemprop="name" content="Combo I, la VPN del pobre">
<meta itemprop="description" content="La VPN del pobre">

<meta itemprop="wordCount" content="717">
<meta itemprop="keywords" content="" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/img/logo.png">
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menú</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">La causa ...</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/aboutme/">
				
				<span class="menu__text">Algo sobre mí ...</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/recursos/">
				
				<span class="menu__text">Recursos</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/recetas/">
				
				<span class="menu__text">Recetas</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/todo/">
				
				<span class="menu__text">Todo en uno</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/combos/">
				
				<span class="menu__text">Combos</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Combo I, la VPN del pobre</h1>
			<div class="post__meta meta"><div class="meta__item-author meta__item">
	<svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2 0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class="meta__text">JaimeAlberto</span>
</div></div>
		</header>
<div class="post__toc toc">
	<div class="toc__title">Índice</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
  <ul>
    <li><a href="#objetivo">Objetivo</a></li>
    <li><a href="#receta">Receta</a>
      <ul>
        <li><a href="#ingredientes">Ingredientes</a></li>
      </ul>
    </li>
    <li><a href="#despliegue">Despliegue</a></li>
    <li><a href="#conclusión">Conclusión</a></li>
  </ul>
</nav>
	</div>
</div><div class="content post__content clearfix">
			<figure><img src="/img/comboI.jpg"/>
</figure>

<p>Recordando viejos tiempos, que uno tiene ya una edad, en aquellos días de los buenos <a href="https://es.wikipedia.org/wiki/Arcade">arcades</a>. Todos andábamos locos con los <a href="https://es.wikipedia.org/wiki/Combo_(videojuegos)">combos.</a></p>
<p>Esa combinación de teclas que nos hacia parecer extraterrestres según movíamos los dedeos en un baile perfecto para que nuestro personaje hiciera un movimiento imposible y dejar al contrario K.O.</p>
<p>Necesitamos:</p>
<ul>
<li><a href="https://jaimealberto.github.io/post/16_terraformi/">Terraform.</a></li>
<li><a href="https://jaimealberto.github.io/post/07_universosshi/#llaves">Llave ssh.</a></li>
<li><a href="https://jaimealberto.github.io/post/11_universosshii/#sshuttle">Sshuttle.</a></li>
<li>Cuenta en <a href="https://www.digitalocean.com/">DigitalOcean.</a></li>
<li><a href="https://docs.digitalocean.com/reference/api/create-personal-access-token/">API Token</a> en <a href="https://www.digitalocean.com/">DigitalOcean.</a></li>
</ul>
<p><em>Nota: Si no tenéis cuenta de DigtalOcean, dejo debajo mi link de referencia por si lo queréis utilizar para probar y me ayudas con unos Euritos para seguir con estos post y muchos mas. Gracias</em></p>
<p><a href="https://www.digitalocean.com/?refcode=b18868ab8e1c&amp;utm_campaign=Referral_Invite&amp;utm_medium=Referral_Program&amp;utm_source=badge"><img src="https://web-platforms.sfo2.digitaloceanspaces.com/WWW/Badge%202.svg" alt="DigitalOcean Referral Badge"></a></p>
<h2 id="objetivo">Objetivo</h2>
<p>Terraformar un host en DigitalOcean el cual nos permita conectarnos mediante ssh. Utilizar sshuttle, como ya hablamos en ……… para enrutar todo nuestro trafico mediante el. De tal manera que nuestra geolocalización no sea la real. Esto nos permitirá  por ejemplo ver contenido de plataformas de video bajo demanda en otros idiomas. Del resto de uso ya sois responsables vosotros, ;-), ser buenos.</p>
<h2 id="receta">Receta</h2>
<p>La receta se compone de 3 ficheros:</p>
<pre tabindex="0"><code>├── _provider.tf     Definición del proveedor
├── main.tf          Receta
└── terraform.tfvars Definición de variables de entorno
</code></pre><h3 id="ingredientes">Ingredientes</h3>
<h4 id="_providertf">_provider.tf</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-terraform" data-lang="terraform"><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;do_token&#34;</span> {}
<span style="color:#a6e22e">terraform</span> {
  <span style="color:#a6e22e">required_version</span> = <span style="color:#e6db74">&#34;&gt;= 0.14.0&#34;</span>

  <span style="color:#a6e22e">required_providers</span> {
    <span style="color:#a6e22e">digitalocean</span> = {
      <span style="color:#a6e22e">source</span> = <span style="color:#e6db74">&#34;digitalocean/digitalocean&#34;</span>
    }
  }
}<span style="color:#75715e">
</span><span style="color:#75715e"># Configure the DigitalOcean Provider
</span><span style="color:#75715e"></span><span style="color:#66d9ef">provider</span> <span style="color:#e6db74">&#34;digitalocean&#34;</span> {
  <span style="color:#a6e22e">token</span> = var.<span style="color:#a6e22e">do_token</span>
}</code></pre></div>
<h4 id="maintf">main.tf</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-terraform" data-lang="terraform"><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;ssh_pub_path&#34;</span>{}<span style="color:#75715e">
</span><span style="color:#75715e">
</span><span style="color:#75715e"># Create a new SSH key
</span><span style="color:#75715e"></span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;digitalocean_ssh_key&#34;</span> <span style="color:#e6db74">&#34;jaimealberto&#34;</span> {
    <span style="color:#a6e22e">name</span>       = <span style="color:#e6db74">&#34;jaimealberto&#34;</span>
    <span style="color:#a6e22e">public_key</span> = file(var.<span style="color:#a6e22e">ssh_pub_path</span>)
}
<span style="color:#66d9ef">
</span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;digitalocean_droplet&#34;</span> <span style="color:#e6db74">&#34;server&#34;</span> {
    <span style="color:#a6e22e">name</span>  = <span style="color:#e6db74">&#34;server&#34;</span>
    <span style="color:#a6e22e">image</span> = <span style="color:#e6db74">&#34;debian-10-x64&#34;</span>
    <span style="color:#a6e22e">region</span> = <span style="color:#e6db74">&#34;fra1&#34;</span>
    <span style="color:#a6e22e">size</span>   = <span style="color:#e6db74">&#34;s-1vcpu-1gb&#34;</span>
    <span style="color:#a6e22e">ssh_keys</span> = [<span style="color:#a6e22e">digitalocean_ssh_key</span>.<span style="color:#a6e22e">jaimealberto</span>.<span style="color:#a6e22e">fingerprint</span>]
}
<span style="color:#66d9ef">
</span><span style="color:#66d9ef">output</span> <span style="color:#e6db74">&#34;ssh&#34;</span> {
    <span style="color:#a6e22e">value</span> = <span style="color:#e6db74">&#34;sshuttle -v --dns -r root@</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">digitalocean_droplet</span>.<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">ipv4_address</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> -e &#34;</span><span style="color:#a6e22e">ssh</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">i</span> <span style="color:#960050;background-color:#1e0010">~</span><span style="color:#f92672">/</span>.<span style="color:#a6e22e">ssh</span><span style="color:#f92672">/</span><span style="color:#a6e22e">id_rsa</span><span style="color:#e6db74">&#34; 0/0&#34;</span>
}</code></pre></div>
<h4 id="terraformtfvars">terraform.tfvars</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-terraform" data-lang="terraform"><span style="color:#75715e"># token API
</span><span style="color:#75715e"></span><span style="color:#a6e22e">do_token</span> = <span style="color:#e6db74">&#34;token generado en DigitalOcean por el usuario&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"># Key Pub
</span><span style="color:#75715e"></span><span style="color:#a6e22e">ssh_pub_path</span>=<span style="color:#e6db74">&#34;~/.ssh/id_rsa.pub&#34;</span></code></pre></div>
<h2 id="despliegue">Despliegue</h2>
<p>Bueno pues una vez que tenemos todo preparado vamos a desplegar nuestra receta.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-zsh" data-lang="zsh">terraform init
terraform validate
terraform plan
terraform apply</code></pre></div>
<p>Como podemos observar al finalizar nos indica con el output que ya preparamos como utilizar nuestro nuevo servicio de “VPN” para tunelizar todo nuestro trafico por el host desplegado. Al ejecutar el comando desde el terminal nos solicita la contraseña de administrador local. Dejamos esta ventana del termina abierta y comenzamos a navegar o a realizar cualquier otra operación, en esta ventana al estar activo el modo verbose veremos como actua.</p>
<p>Comprobamos que funciona desde otro terminal, por ejemplo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-zsh" data-lang="zsh">curl ifconfig.io</code></pre></div>
<p>Ya vemos que nos da una ip que no es la nuestra real por geolocalización. Ya podemos hacer lo teniamos que hacer con el túnel levantado. Una vez finalizadas las teras detemos el proceso con Ctrl + c y todo seguirá igual respecto a la salida de trafico de nuestro host local.</p>
<p>Como ya hemos terminado con lo que teinamos que hacer, ahora destruimos la infraestructura para no pagar por algo que no utilizamos.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-zsh" data-lang="zsh">terraform destroy</code></pre></div>
<p>Aquí podemos ver el proceso completo:</p>
<figure><img src="/img/ComboI.gif"/>
</figure>

<p>Como se puede observar en el proceso:</p>
<ul>
<li>Se inicia la conexión con el proveedor.</li>
<li>Se verifica la configuración.</li>
<li>Se realiza el plan.</li>
<li>Se aplica el plan.</li>
<li>Se lanza el comando que crea el túnel contra el host remoto.</li>
<li>Se verifica la conexión como se puede observar mas abajo.</li>
<li>Se pulsa Crtl + c para finalizar el túnel.</li>
<li>Se destruye todo lo creado para no generar gasto.</li>
</ul>
<p>Se utiliza una <a href="https://jaimealberto.github.io/post/07_universosshi/#llaves">llave</a> que cree para grabar el gif.
Solicita la contraseña de administrador de mi host puesto que tiene que manejar el trafico saliente del equipo.</p>
<p>Pruebas:</p>
<p>Como podemos ver la ip publica actual corresponde con la zona geográfica elegida en el despliegue del droplet en DigitalOcean.</p>
<p>Desde el terminal:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-zsh" data-lang="zsh">ip<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl ifconfig.io<span style="color:#66d9ef">)</span> <span style="color:#f92672">&amp;&amp;</span> curl ipinfo.io/$ip
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
<span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">15</span>  <span style="color:#ae81ff">100</span>    <span style="color:#ae81ff">15</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">72</span>      <span style="color:#ae81ff">0</span> --:--:-- --:--:-- --:--:--    <span style="color:#ae81ff">72</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;ip&#34;</span>: <span style="color:#e6db74">&#34;134.209.247.46&#34;</span>,
  <span style="color:#e6db74">&#34;city&#34;</span>: <span style="color:#e6db74">&#34;Frankfurt am Main&#34;</span>,
  <span style="color:#e6db74">&#34;region&#34;</span>: <span style="color:#e6db74">&#34;Hesse&#34;</span>,
  <span style="color:#e6db74">&#34;country&#34;</span>: <span style="color:#e6db74">&#34;DE&#34;</span>,
  <span style="color:#e6db74">&#34;loc&#34;</span>: <span style="color:#e6db74">&#34;50.1155,8.6842&#34;</span>,
  <span style="color:#e6db74">&#34;org&#34;</span>: <span style="color:#e6db74">&#34;AS14061 DigitalOcean, LLC&#34;</span>,
  <span style="color:#e6db74">&#34;postal&#34;</span>: <span style="color:#e6db74">&#34;60311&#34;</span>,
  <span style="color:#e6db74">&#34;timezone&#34;</span>: <span style="color:#e6db74">&#34;Europe/Berlin&#34;</span>,
  <span style="color:#e6db74">&#34;readme&#34;</span>: <span style="color:#e6db74">&#34;https://ipinfo.io/missingauth&#34;</span>
<span style="color:#f92672">}</span></code></pre></div>
<p>Desde el navegador:</p>
<figure><img src="/img/ComboI.png"/>
</figure>

<h2 id="conclusión">Conclusión</h2>
<p>Hemos desplegado una solución rapida para tener un túnel de trafico cifrado desde nuestro host a un proveedor que nos situá geográficamente en otro lugar. La utilizamos el tiempo necesario y luego lo destruimos. Esto nos da una flexibilidad muy grande y pagamos solo por lo que utilizamos ni un euro mas. Espero que sea útil y nos vemos el la próxima.</p>
		</div>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="JaimeAlberto avatar" src="/img/avatar.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">Sobre el autor JaimeAlberto</span>
	</div>
	<div class="authorbox__description">
		The BOFH of this Site
	</div>
</div>



			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
<div class="footer__links">
	<a class="footer__link" href="/licencia/">Licencia CC BY-NC-SA 4.0</a>
</div>
		<div class="footer__copyright">
			&copy; 2021 JaimeAlberto.
			<span class="footer__copyright-credits">Generado con <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> y <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a>.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
<script src="/js/custom.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>